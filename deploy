PATH=/bin:/usr/bin:/usr/local/bin

set -e

printUsage()
{
    cat 1>&2 <<EOF
Usage: `basename $0` [-M <make>] [-m] [-n] [-s] [-u <user>] <version> <host>
Where:
    -M <make>   Pathname of make(1) utility when root
    -m          Enable multicast support
    -n          Enable NOAAPort support
    -s          Use sudo(1) instead of logging in as "root"
    -u <user>   Use <user> instead of "ldm"
    <version>   LDM version (e.g., "6.13.8.8")
    <host>      Remote host (e.g., "node4.unidata.ucar.edu")
EOF
}

makePath=make
user=ldm

while getopts M:mnsu: opt; do
    case $opt in
        M) makePath=$OPTARG;;
        m) withMulticast=true;;
        n) withNoaaport=true;;
        s) useSudo=true;;
        u) user=$OPTARG;;
        *) printUsage
           exit 1;;
    esac
done
shift `expr $OPTIND - 1`
version=${1?Version not specified}
host=${2?Host not specified}

pkgId=ldm-$version
tarball=$pkgId.tar.gz

scp $tarball $host:

# ssh(1) is used thrice because some security policies doesn't allow
# ssh(1)ing to the remote host and then executing su(1) in a here-document.

ssh -T $host bash --login <<EOF
    set -x -e
    gunzip -c $tarball | pax -r '-s:/:/src/:'
    cd $pkgId/src/
    ./configure --disable-root-actions --enable-debug \
            ${withMulticast+--with-multicast} ${withNoaaport+--with-noaaport} \
            >&configure.log
    make install >&install.log
EOF

if test "${useSudo+true}"; then
    ssh $host bash --login <<EOF
        set -x -e
        cd $pkgId/src
        sudo make root-actions >&root-actions.log
        echo Root actions made
EOF
else
    ssh -T root@$host bash --login <<EOF
        set -x -e
        cd ~$user/$pkgId/src
        $makePath root-actions >&root-actions.log
        echo Root actions made
EOF
fi

ssh -T $host bash --login <<EOF
    set -x -e
    if ldmadmin stop; then
        rm -f runtime || echo "Runtime link doesn't exist"
        ln -s $pkgId runtime
        ldmadmin start
    else
        echo "LDM isn't running. New installation not started."
        ln -s $pkgId runtime
    fi
EOF